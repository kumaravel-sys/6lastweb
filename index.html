<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VSE Stock Trainer</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/lightweight-charts@3.9.0/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: Arial, sans-serif; background:#f5f7fb; margin:0; }
.hidden { display:none; }
input, button, select { padding:8px; margin:5px 0; width:100%; max-width:300px; }
table { border-collapse: collapse; width:100%; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
.navbar { background:#1e40af; color:white; padding:10px; display:flex; gap:10px; }
.navbar button { background:#3b82f6; border:none; color:white; padding:8px 12px; cursor:pointer; border-radius:5px; }
.card { background:white; padding:15px; border-radius:8px; margin:10px 0; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div id="login-page" class="p-5">
  <h2 class="text-xl font-bold mb-3">Stock Trainer Login</h2>
  <div id="common-pass-div">
    <input type="password" id="common-pass" placeholder="Enter common password" class="border rounded">
    <button onclick="verifyCommonPassword()" class="mt-2 bg-blue-500 text-white rounded px-3 py-1">Next</button>
  </div>
  <div id="email-pass-div" class="hidden mt-3">
    <input type="email" id="email" placeholder="Email" class="border rounded">
    <input type="password" id="password" placeholder="Password" class="border rounded">
    <button onclick="loginUser()" class="mt-2 bg-blue-500 text-white rounded px-3 py-1">Login</button>
  </div>
</div>

<!-- MAIN TRAINER PAGE -->
<div id="trainer-page" class="hidden p-5">
  <div class="navbar mb-5">
    <button onclick="showPage('stocks')">üìä Stocks</button>
    <button onclick="showPage('holdings')">üíº Holdings</button>
    <button onclick="showPage('orders')">üßæ Orders</button>
    <button onclick="showPage('watchlist')">‚≠ê Watchlist</button>
    <button onclick="showPage('admin')">‚öôÔ∏è Admin Panel</button>
    <span class="ml-auto">User: <span id="user-name"></span></span>
    <button onclick="logoutUser()" class="ml-2 bg-red-500">Logout</button>
  </div>

  <!-- STOCKS PAGE -->
  <div id="stocks" class="page">
    <div class="card">
      <input type="text" id="stock-search" placeholder="Search NSE stock symbol e.g. TATAMOTORS" onkeyup="searchStock()">
      <select id="stock-list" onchange="updateChart(this.value)">
        <option value="">Select a stock</option>
      </select>
    </div>
    <div id="chart-container" class="card" style="height:400px;"></div>
    <div class="card">
      <input type="number" id="buy-qty" placeholder="Quantity to Buy">
      <button onclick="buyStock()" class="bg-green-500 text-white rounded px-3 py-1 mt-2">Buy</button>
    </div>
  </div>

  <!-- HOLDINGS PAGE -->
  <div id="holdings" class="page hidden">
    <h3 class="text-lg font-bold mb-2">Your Holdings</h3>
    <table class="w-full">
      <thead>
        <tr><th>Stock</th><th>Quantity</th><th>Avg Price</th><th>Current Price</th><th>Value</th><th>Action</th></tr>
      </thead>
      <tbody id="portfolio-body"></tbody>
    </table>
  </div>

  <!-- ORDERS PAGE -->
  <div id="orders" class="page hidden">
    <h3 class="text-lg font-bold mb-2">Orders</h3>
    <table class="w-full">
      <thead>
        <tr><th>Stock</th><th>Quantity</th><th>Price</th><th>Status</th></tr>
      </thead>
      <tbody id="orders-body"></tbody>
    </table>
  </div>

  <!-- WATCHLIST PAGE -->
  <div id="watchlist" class="page hidden">
    <h3 class="text-lg font-bold mb-2">Watchlist</h3>
    <ul id="watchlist-body"></ul>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin" class="page hidden">
    <h3 class="text-lg font-bold mb-2">Admin Panel</h3>
    <table class="w-full">
      <thead>
        <tr><th>User</th><th>Balance</th><th>Portfolio Value</th><th>Transactions</th></tr>
      </thead>
      <tbody id="admin-body"></tbody>
    </table>
  </div>

  <div class="mt-3">Balance: ‚Çπ<span id="balance">0</span></div>
</div>

<script>
  // ===== FIREBASE CONFIG =====
  const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBFLVuBT-sSdcq-MjiL5tB17mfeNpP2jN8",
  authDomain: "vsestocktrainer-a5b04.firebaseapp.com",
  projectId: "vsestocktrainer-a5b04",
  storageBucket: "vsestocktrainer-a5b04.firebasestorage.app",
  messagingSenderId: "652083011735",
  appId: "1:652083011735:web:3ab6396a3d5888abec49d2"
};
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ===== CREDENTIALS =====
  const COMMON_PASSWORD = "vse2k25";
  const ADMIN_EMAIL = "admin6@vse.com";
  const ADMIN_PASSWORD = "adminvse2k25";

  let currentUser = null;
  let chart, series, chartSymbol;
  let stockData = {}; // live prices

  // ===== NAVIGATION =====
  function showPage(pageId){
    document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
    document.getElementById(pageId).classList.remove('hidden');
  }

  // ===== LOGIN FLOW =====
  function verifyCommonPassword(){
    if(document.getElementById('common-pass').value === COMMON_PASSWORD){
      document.getElementById('common-pass-div').classList.add('hidden');
      document.getElementById('email-pass-div').classList.remove('hidden');
    } else alert("Incorrect common password");
  }

  function loginUser(){
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email,password).then(res=>{
      currentUser = res.user;
      loadUserData();
    }).catch(err=>{
      if(email===ADMIN_EMAIL && password===ADMIN_PASSWORD){
        auth.signInAnonymously().then(res=>{
          currentUser = {uid:"admin", email:ADMIN_EMAIL};
          loadUserData();
        });
      } else alert(err.message);
    });
  }

  function logoutUser(){ auth.signOut().then(()=>location.reload()); }

  // ===== LOAD USER DATA =====
  function loadUserData(){
    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('trainer-page').classList.remove('hidden');
    document.getElementById('user-name').innerText = currentUser.email || "Admin";
    db.collection('users').doc(currentUser.uid).get().then(doc=>{
      if(!doc.exists){
        db.collection('users').doc(currentUser.uid).set({
          balance:50000, portfolio:{}, orders:[], watchlist:[]
        });
      }
      refreshAll();
    });
  }

  // ===== NSE STOCKS =====
  const NSE_TICKERS = ["TATAMOTORS","INFY","RELIANCE","TCS","HDFCBANK","ICICIBANK","LT","AXISBANK","SBIN","HINDUNILVR","ITC","BAJFINANCE","MARUTI"];
  function loadStockList(){
    const sel = document.getElementById('stock-list');
    sel.innerHTML='<option value="">Select a stock</option>';
    NSE_TICKERS.forEach(t=>{
      let o=document.createElement('option'); o.value=t; o.innerText=t; sel.appendChild(o);
    });
  }

  function searchStock(){
    const val=document.getElementById('stock-search').value.toUpperCase();
    const sel=document.getElementById('stock-list');
    for(let i=0;i<sel.options.length;i++){
      sel.options[i].style.display=sel.options[i].value.includes(val)?'none':'none';
      if(sel.options[i].value.includes(val)) sel.options[i].style.display='';
    }
  }

  // ===== LIGHTWEIGHT LIVE CHART =====
  function updateChart(symbol){
    chartSymbol=symbol;
    if(!chart){
      chart = LightweightCharts.createChart(document.getElementById('chart-container'), {width: document.getElementById('chart-container').offsetWidth, height:400});
      series = chart.addLineSeries({color:'#1e40af'});
    }
    fetchStockData(symbol);
  }

  async function fetchStockData(symbol){
    if(!symbol) return;
    // Simulate live price with random walk
    if(!stockData[symbol]) stockData[symbol]=[ {time: Math.floor(Date.now()/1000), value: 500} ];
    let last = stockData[symbol][stockData[symbol].length-1].value;
    let newVal = last + (Math.random()*10-5);
    stockData[symbol].push({time: Math.floor(Date.now()/1000), value: newVal});
    if(stockData[symbol].length>50) stockData[symbol].shift();
    series.setData(stockData[symbol]);
    document.getElementById('balance').innerText = '‚Çπ'+ (Math.floor(Math.random()*100000)); // placeholder balance
    setTimeout(()=>fetchStockData(symbol),3000);
  }

  // ===== BUY/SELL =====
  function buyStock(){
    const qty = parseInt(document.getElementById('buy-qty').value);
    if(!qty || !chartSymbol) return alert("Select stock and quantity");
    db.collection('users').doc(currentUser.uid).get().then(doc=>{
      let data=doc.data();
      const price=stockData[chartSymbol][stockData[chartSymbol].length-1].value;
      if(data.balance<price*qty) return alert("Insufficient balance");
      data.balance-=price*qty;
      if(!data.portfolio[chartSymbol]) data.portfolio[chartSymbol]={quantity:0, avgPrice:0};
      let p=data.portfolio[chartSymbol];
      p.avgPrice=(p.avgPrice*p.quantity + price*qty)/(p.quantity+qty);
      p.quantity+=qty;
      db.collection('users').doc(currentUser.uid).update({balance:data.balance, portfolio:data.portfolio});
      refreshAll();
    });
  }

  function refreshAll(){
    loadStockList();
    refreshPortfolio();
    refreshOrders();
    refreshWatchlist();
    refreshAdmin();
  }

  function refreshPortfolio(){
    db.collection('users').doc(currentUser.uid).get().then(doc=>{
      const data=doc.data();
      const tbody=document.getElementById('portfolio-body');
      tbody.innerHTML='';
      for(let s in data.portfolio){
        const p=data.portfolio[s];
        const price=stockData[s]?[stockData[s][stockData[s].length-1].value]:0;
        const val=price*p.quantity;
        let row=document.createElement('tr');
        row.innerHTML=`<td>${s}</td><td>${p.quantity}</td><td>${p.avgPrice.toFixed(2)}</td><td>${price.toFixed(2)}</td><td>${val.toFixed(2)}</td><td><button onclick="sellStock('${s}')">Sell</button></td>`;
        tbody.appendChild(row);
      }
    });
  }

  function sellStock(symbol){
    db.collection('users').doc(currentUser.uid).get().then(doc=>{
      let data=doc.data();
      const qty=data.portfolio[symbol].quantity;
      const price=stockData[symbol][stockData[symbol].length-1].value;
      data.balance+=qty*price;
      delete data.portfolio[symbol];
      db.collection('users').doc(currentUser.uid).update({balance:data.balance, portfolio:data.portfolio});
      refreshAll();
    });
  }

  // ===== ORDERS/WATCHLIST/ADMIN =====
  function refreshOrders(){ /* placeholder */ }
  function refreshWatchlist(){ /* placeholder */ }
  function refreshAdmin(){
    if(currentUser.email===ADMIN_EMAIL){
      db.collection('users').get().then(snap=>{
        const tbody=document.getElementById('admin-body'); tbody.innerHTML='';
        snap.forEach(doc=>{
          const d=doc.data(); let val=0;
          for(let s in d.portfolio){
            val+=d.portfolio[s].quantity* (stockData[s]?stockData[s][stockData[s].length-1].value:0);
          }
          let row=document.createElement('tr');
          row.innerHTML=`<td>${doc.id}</td><td>${d.balance}</td><td>${val.toFixed(2)}</td><td>${(d.orders?d.orders.length:0)}</td>`;
          tbody.appendChild(row);
        });
      });
    }
  }

</script>
</body>
</html>
